<div class="page-header">
  <h1><%= current_account&.name %> Timeline</h1>
  <span class="nav-subtitle">Signed in as <%= current_user.email %></span>
  <% if can_write? %>
    <%= link_to "Add Entry", new_entry_path, class: "btn btn-gold" %>
  <% end %>
</div>

<div class="filters">
  <h3>Filter Timeline</h3>
  <%= form_with url: root_path, method: :get, local: true do |f| %>
    <div class="filter-row">
      <div class="filter-group">
        <%= label_tag :decade, "Decade" %>
        <%= select_tag :decade,
            options_for_select([["All Decades", ""]] + @decades, params[:decade]),
            onchange: "this.form.submit()" %>
      </div>
      <div class="filter-group">
        <%= label_tag :entry_type, "Event Type" %>
        <%= select_tag :entry_type,
            options_for_select([["All Types", ""]] + @entry_types.map { |t| [t.titleize, t] }, params[:entry_type]),
            onchange: "this.form.submit()" %>
      </div>
      <div class="filter-group">
        <%= label_tag :character_id, "Character" %>
        <%= select_tag :character_id,
            options_for_select([["All Characters", ""]] + @characters.map { |c| [c.name, c.id] }, params[:character_id]),
            onchange: "this.form.submit()" %>
      </div>
      <div class="filter-group">
        <%= link_to "Clear Filters", root_path, class: "btn btn-secondary" %>
      </div>
    </div>
  <% end %>
</div>

<% if @timeline_items.any? %>
  <div class="timeline" data-controller="timeline-lightbox">
    <% @timeline_items.group_by { |item| item[:year] }.each do |year, items| %>
      <div class="timeline-year">
        <% items.each do |item| %>
          <% if item[:type] == :image %>
            <% image = item[:object] %>
            <div class="timeline-entry timeline-image">
              <div class="timeline-date"><%= image.date_display %></div>
              <div class="timeline-image-container">
                <% if image.file.attached? %>
                  <%= image_tag image.file.variant(:timeline),
                      alt: image.display_title,
                      class: "timeline-thumbnail",
                      loading: "lazy",
                      data: {
                        action: "click->timeline-lightbox#open",
                        full_url: url_for(image.file),
                        title: image.display_title,
                        image_path: image_path(image)
                      } %>
                <% end %>
                <div class="timeline-image-info">
                  <h3 class="timeline-title"><%= image.display_title %></h3>
                  <% if image.location.present? %>
                    <p class="timeline-meta"><%= image.location %></p>
                  <% end %>
                  <% if image.characters.any? %>
                    <div class="timeline-meta">
                      <% image.characters.each do |character| %>
                        <% age = character.age_at(image.taken_date) %>
                        <%= link_to character, class: "tag tag-character" do %>
                          <%= character.name %><% if age %> - <%= age %><% end %>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% elsif item[:type] == :entry %>
            <% entry = item[:object] %>
            <div class="timeline-entry <%= 'has-image' if entry.card_image&.file&.attached? %>">
              <div class="timeline-date"><%= entry.date_display %></div>
              <div class="timeline-entry-content">
                <% if entry.card_image&.file&.attached? %>
                  <div class="timeline-entry-image">
                    <%= link_to entry do %>
                      <%= image_tag entry.card_image.file.variant(:timeline), alt: entry.title, loading: "lazy", class: "timeline-thumbnail" %>
                    <% end %>
                  </div>
                <% end %>
                <div class="timeline-entry-text">
                  <h3 class="timeline-title">
                    <%= link_to entry.title, entry %>
                  </h3>
                  <% if entry.location.present? %>
                    <div class="timeline-meta"><span><%= entry.location %></span></div>
                  <% end %>
                  <% if entry.description.present? %>
                    <p class="timeline-description"><%= truncate(entry.description, length: 200) %></p>
                  <% end %>
                </div>
              </div>
              <div class="timeline-meta">
                <% if entry.entry_type.present? %>
                  <span class="tag tag-type"><%= entry.entry_type.titleize %></span>
                <% end %>
                <% entry.characters.each do |character| %>
                  <% age = character.age_at(entry.event_date_for_age) %>
                  <%= link_to character, class: "tag tag-character" do %>
                    <%= character.name %><% if age %> - <%= age %><% end %>
                  <% end %>
                <% end %>
                <% if entry.verified? %>
                  <span class="tag tag-verified">Verified</span>
                <% else %>
                  <span class="tag tag-unverified">Unverified</span>
                <% end %>
              </div>
              <% if entry.entry_sources.any? %>
                <div class="source-citation">
                  <% if entry.entry_sources.count == 1 %>
                    <% es = entry.entry_sources.first %>
                    Source: <%= link_to es.source.display_name, es.source %>
                    <% if es.page_reference.present? %>(p. <%= es.page_reference %>)<% end %>
                  <% else %>
                    Sources: <%= entry.entry_sources.includes(:source).map { |es| link_to(es.source.title, es.source) }.join(", ").html_safe %>
                  <% end %>
                </div>
              <% elsif entry.source.present? %>
                <div class="source-citation">
                  Source: <%= link_to entry.source.display_name, entry.source %>
                  <% if entry.page_reference.present? %>
                    (p. <%= entry.page_reference %>)
                  <% end %>
                </div>
              <% end %>
            </div>
          <% elsif item[:type] == :asset %>
            <% asset = item[:object] %>
            <div class="timeline-entry timeline-asset">
              <div class="timeline-date"><%= asset.acquisition_date_display %></div>
              <div class="timeline-entry-content">
                <% if asset.card_image&.file&.attached? %>
                  <div class="timeline-entry-image">
                    <%= link_to asset do %>
                      <%= image_tag asset.card_image.file.variant(:timeline), alt: asset.name, loading: "lazy", class: "timeline-thumbnail" %>
                    <% end %>
                  </div>
                <% end %>
                <div class="timeline-entry-text">
                  <h3 class="timeline-title">
                    <%= link_to "Acquired: #{asset.name}", asset %>
                  </h3>
                  <% if asset.manufacturer.present? %>
                    <div class="timeline-meta"><span>Made by: <%= asset.manufacturer %></span></div>
                  <% end %>
                  <% if asset.description.present? %>
                    <p class="timeline-description"><%= truncate(asset.description, length: 200) %></p>
                  <% end %>
                  <div class="timeline-meta">
                    <span class="tag tag-asset"><%= asset.type_display %></span>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% end %>

    <div class="timeline-lightbox hidden" data-timeline-lightbox-target="modal">
      <div class="timeline-lightbox-overlay" data-action="click->timeline-lightbox#close"></div>
      <div class="timeline-lightbox-content">
        <button type="button" class="timeline-lightbox-close" data-action="click->timeline-lightbox#close">&times;</button>
        <img data-timeline-lightbox-target="image" src="" alt="">
        <div class="timeline-lightbox-footer">
          <p class="timeline-lightbox-title" data-timeline-lightbox-target="title"></p>
          <a href="#" class="btn btn-secondary btn-small" data-timeline-lightbox-target="link">View Image Details</a>
        </div>
      </div>
    </div>
  </div>
<% else %>
  <div class="empty-state">
    <h3>No Timeline Entries Yet</h3>
    <p>Start adding entries from your research to build the Onassis timeline.</p>
    <% if can_write? %>
      <%= link_to "Add Your First Entry", new_entry_path, class: "btn btn-gold" %>
    <% end %>
  </div>
<% end %>

<% if @undated_images.any? %>
  <div class="undated-images-section" data-controller="timeline-lightbox">
    <h2>Undated Images (<%= @undated_images.count %>)</h2>
    <% if can_write? %>
      <p class="section-hint">These images don't have dates assigned yet. Edit an image to add a date and it will appear on the timeline above.</p>
    <% else %>
      <p class="section-hint">These images don't have dates assigned yet.</p>
    <% end %>

    <div class="undated-images-grid">
      <% @undated_images.each do |image| %>
        <div class="undated-image-item">
          <% if image.file.attached? %>
            <%= image_tag image.file.variant(:small),
                alt: image.display_title,
                class: "undated-thumbnail",
                loading: "lazy",
                data: {
                  action: "click->timeline-lightbox#open",
                  full_url: url_for(image.file),
                  title: image.display_title,
                  image_path: image_path(image)
                } %>
          <% end %>
          <div class="undated-image-info">
            <p class="undated-image-title"><%= link_to image.display_title, image %></p>
            <% if image.characters.any? %>
              <div class="undated-image-characters">
                <% image.characters.limit(3).each do |character| %>
                  <span class="tag tag-character-small"><%= character.name %></span>
                <% end %>
                <% if image.characters.count > 3 %>
                  <span class="tag tag-more">+<%= image.characters.count - 3 %></span>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="timeline-lightbox hidden" data-timeline-lightbox-target="modal">
      <div class="timeline-lightbox-overlay" data-action="click->timeline-lightbox#close"></div>
      <div class="timeline-lightbox-content">
        <button type="button" class="timeline-lightbox-close" data-action="click->timeline-lightbox#close">&times;</button>
        <img data-timeline-lightbox-target="image" src="" alt="">
        <div class="timeline-lightbox-footer">
          <p class="timeline-lightbox-title" data-timeline-lightbox-target="title"></p>
          <a href="#" class="btn btn-secondary btn-small" data-timeline-lightbox-target="link">View Image Details</a>
        </div>
      </div>
    </div>
  </div>
<% end %>
