<div class="page-header">
  <h1><%= @image.display_title %></h1>
  <div class="actions">
    <%= link_to "Edit", edit_image_path(@image), class: "btn btn-secondary" %>
    <%= link_to "Delete", @image, data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this image?" }, class: "btn btn-danger" %>
    <%= link_to "Back to Gallery", images_path, class: "btn btn-primary" %>
  </div>
</div>

<div class="image-show-container">
  <div class="image-main">
    <% if @image.file.attached? %>
      <%= image_tag @image.file, class: "image-full" %>
    <% end %>
  </div>

  <div class="image-details">
    <div class="card">
      <div class="detail-grid">
        <div class="detail-item">
          <label>Date Taken</label>
          <div class="value"><%= @image.date_display %></div>
        </div>
        <% if @image.location.present? %>
          <div class="detail-item">
            <label>Location</label>
            <div class="value"><%= @image.location %></div>
          </div>
        <% end %>
      </div>
    </div>

    <% if @image.notes.present? %>
      <div class="detail-section">
        <h2>Notes</h2>
        <div class="card">
          <p><%= simple_format(@image.notes) %></p>
        </div>
      </div>
    <% end %>

    <% if @image.source_url.present? || @image.has_source_info? %>
      <div class="detail-section">
        <h2>Source</h2>
        <div class="card">
          <% if @image.article_title.present? || @image.article_url.present? %>
            <div class="source-info-item">
              <label>Article</label>
              <div class="value">
                <% if @image.article_url.present? %>
                  <%= link_to (@image.article_title.presence || "View Article"), @image.article_url, target: "_blank", rel: "noopener noreferrer" %>
                <% else %>
                  <%= @image.article_title %>
                <% end %>
                <% if @image.article_author.present? %>
                  <span class="article-author">by <%= @image.article_author %></span>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @image.website_name.present? || @image.website_url.present? %>
            <div class="source-info-item">
              <label>Website</label>
              <div class="value">
                <% if @image.website_url.present? %>
                  <%= link_to (@image.website_name.presence || @image.website_url), @image.website_url, target: "_blank", rel: "noopener noreferrer" %>
                <% else %>
                  <%= @image.website_name %>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @image.source_url.present? %>
            <div class="source-info-item">
              <label>Image URL</label>
              <div class="value">
                <%= link_to truncate(@image.source_url, length: 60), @image.source_url, target: "_blank", rel: "noopener noreferrer" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if @image.characters.any? %>
      <div class="detail-section">
        <h2>People in this Image (<%= @image.characters.count %>)</h2>
        <div class="card">
          <ul class="character-list">
            <% @image.characters.by_name.each do |character| %>
              <li>
                <%= link_to character.name, character %>
                <% if character.relationship.present? %>
                  <span class="tag"><%= character.relationship.titleize %></span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>

    <% if @image.entries.any? %>
      <div class="detail-section">
        <h2>Related Events (<%= @image.entries.count %>)</h2>
        <% @image.entries.chronological.each do |entry| %>
          <div class="card source-card">
            <div class="source-header">
              <strong><%= link_to entry.title, entry %></strong>
              <% if entry.entry_type.present? %>
                <span class="tag tag-type"><%= entry.entry_type.titleize %></span>
              <% end %>
            </div>
            <p class="source-pages"><%= entry.date_display %></p>
          </div>
        <% end %>
      </div>
    <% end %>

    <% if @image.locations.any? %>
      <div class="detail-section">
        <h2>Locations (<%= @image.locations.count %>)</h2>
        <div class="card">
          <ul class="character-list">
            <% @image.locations.by_name.each do |location| %>
              <li>
                <%= link_to location.name, location %>
                <% if location.location_type.present? %>
                  <span class="tag tag-location"><%= location.location_type.titleize %></span>
                <% end %>
                <% if location.short_location.present? && location.short_location != location.name %>
                  <span class="location-meta"><%= location.short_location %></span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>

    <% if @image.assets.any? %>
      <div class="detail-section">
        <h2>Assets (<%= @image.assets.count %>)</h2>
        <div class="card">
          <ul class="character-list">
            <% @image.assets.by_name.each do |asset| %>
              <li>
                <%= link_to asset.name, asset %>
                <% if asset.asset_type.present? %>
                  <span class="tag tag-asset"><%= asset.type_display %></span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>
  </div>
</div>
