<%= form_with model: @character, local: true do |f| %>
  <% if @character.errors.any? %>
    <div class="error-messages">
      <h3><%= pluralize(@character.errors.count, "error") %> prohibited this character from being saved:</h3>
      <ul>
        <% @character.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group">
    <%= f.label :name %>
    <%= f.text_field :name, placeholder: "e.g., Jacqueline Kennedy" %>
  </div>

  <div class="form-group">
    <div class="form-checkbox">
      <%= f.check_box :lead_character %>
      <%= f.label :lead_character, "Lead Character (fallback default when no Main Character is set in Timeline Settings)" %>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <%= f.label :relationship, "Relationship to Onassis" %>
      <%= f.select :relationship, Character::RELATIONSHIPS.map { |r| [r.titleize, r] }, { include_blank: "Select relationship..." } %>
    </div>

    <div class="form-group">
      <%= f.label :nationality %>
      <%= f.text_field :nationality, placeholder: "e.g., American" %>
    </div>

    <div class="form-group">
      <%= f.label :occupation %>
      <%= f.text_field :occupation, placeholder: "e.g., First Lady, Editor" %>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <%= f.label :birth_date, "Date of Birth" %>
      <%= f.date_field :birth_date, min: "1800-01-01", max: "2100-12-31" %>
    </div>

    <div class="form-group">
      <%= f.label :death_date, "Date of Death" %>
      <%= f.date_field :death_date, min: "1800-01-01", max: "2100-12-31" %>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :bio, "Biography / Notes" %>
    <%= f.text_area :bio, placeholder: "Background information, significance to Onassis's life, dramatic potential for the series..." %>
  </div>

  <div class="form-section">
    <h3>Links</h3>
    <p class="form-hint">Add links to Wikipedia, biographies, or other relevant resources.</p>

    <div id="character-links">
      <%= f.fields_for :character_links do |link| %>
        <%= render "character_link_fields", f: link %>
      <% end %>
    </div>

    <div class="form-group">
      <%= link_to "Add Link", "#", class: "btn btn-secondary btn-small", id: "add-character-link-btn" %>
    </div>
  </div>

  <div class="form-section" data-controller="gallery-picker" data-gallery-picker-featured-value="<%= @character.featured_image_id %>" data-gallery-picker-input-name-value="character[image_ids][]">
    <h3>Images of this Person</h3>
    <button type="button" class="btn btn-secondary btn-small" style="margin-bottom: 1rem;" data-action="click->gallery-picker#open">
      Select from Gallery
    </button>
    <p class="form-hint">Click the star on an image to set it as the card thumbnail.</p>

    <input type="hidden" name="character[featured_image_id]" value="<%= @character.featured_image_id %>" data-gallery-picker-target="featuredInput">

    <div class="selected-images-preview" data-gallery-picker-target="preview">
      <% @character.images.each do |image| %>
        <div class="selected-image-thumb <%= 'is-featured' if @character.featured_image_id == image.id %>" data-image-id="<%= image.id %>">
          <% if image.file.attached? %>
            <%= image_tag image.file.variant(:picker),
                alt: image.display_title,
                data: { action: "click->gallery-picker#showLightbox", full_url: url_for(image.file), title: image.display_title } %>
          <% end %>
          <button type="button" class="featured-image-btn" data-action="click->gallery-picker#setFeatured" data-image-id="<%= image.id %>" title="Set as card image">&#9733;</button>
          <button type="button" class="remove-image-btn" data-action="click->gallery-picker#removeImage" data-image-id="<%= image.id %>">&times;</button>
        </div>
      <% end %>
    </div>

    <div class="selected-image-ids" data-gallery-picker-target="hiddenInputs">
      <% @character.images.each do |image| %>
        <input type="hidden" name="character[image_ids][]" value="<%= image.id %>" data-image-id="<%= image.id %>">
      <% end %>
    </div>

    <div class="gallery-picker-modal hidden" data-gallery-picker-target="modal">
      <div class="gallery-picker-overlay" data-action="click->gallery-picker#close"></div>
      <div class="gallery-picker-content">
        <div class="gallery-picker-header">
          <h3>Select Images</h3>
          <button type="button" class="gallery-picker-close" data-action="click->gallery-picker#close">&times;</button>
        </div>
        <div class="gallery-picker-grid">
          <% @images.each do |image| %>
            <div class="gallery-picker-item"
                 data-action="click->gallery-picker#toggleImage"
                 data-image-id="<%= image.id %>"
                 data-image-title="<%= image.display_title %>"
                 data-image-url="<%= image.file.attached? ? url_for(image.file.variant(:picker)) : '' %>"
                 data-image-full-url="<%= image.file.attached? ? url_for(image.file) : '' %>"
                 data-gallery-picker-target="item"
                 data-selected="<%= @character.images.include?(image) %>">
              <% if image.file.attached? %>
                <%= image_tag image.file.variant(:picker_wide), alt: image.display_title %>
              <% end %>
              <p class="gallery-picker-item-title"><%= truncate(image.display_title, length: 30) %></p>
              <div class="gallery-picker-check">&#10003;</div>
            </div>
          <% end %>
        </div>
        <div class="gallery-picker-footer">
          <button type="button" class="btn btn-gold" data-action="click->gallery-picker#confirm">Done</button>
          <button type="button" class="btn btn-secondary" data-action="click->gallery-picker#close">Cancel</button>
        </div>
      </div>
    </div>

    <div class="image-lightbox hidden" data-gallery-picker-target="lightbox">
      <div class="image-lightbox-overlay" data-action="click->gallery-picker#closeLightbox"></div>
      <div class="image-lightbox-content">
        <button type="button" class="image-lightbox-close" data-action="click->gallery-picker#closeLightbox">&times;</button>
        <img data-gallery-picker-target="lightboxImage" src="" alt="">
        <p class="image-lightbox-title" data-gallery-picker-target="lightboxTitle"></p>
      </div>
    </div>
  </div>

  <div class="form-actions">
    <%= f.submit class: "btn btn-gold" %>
    <%= link_to "Cancel", characters_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<template id="character-link-template">
  <div class="link-fields">
    <div class="form-row">
      <div class="form-group" style="flex: 2;">
        <label>URL</label>
        <input type="url" name="character[character_links_attributes][NEW_RECORD][url]" placeholder="https://...">
      </div>
      <div class="form-group" style="flex: 1;">
        <label>Label (optional)</label>
        <input type="text" name="character[character_links_attributes][NEW_RECORD][label]" placeholder="e.g., Wikipedia">
      </div>
      <div class="form-group" style="flex: 0 0 auto; align-self: flex-end;">
        <a href="#" class="btn btn-danger btn-small remove-link">Remove</a>
      </div>
    </div>
  </div>
</template>

<script>
  (function() {
    let linkIndex = <%= @character.character_links.length %>;

    const addBtn = document.getElementById('add-character-link-btn');
    const container = document.getElementById('character-links');
    const template = document.getElementById('character-link-template');

    if (addBtn && container && template) {
      addBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const newFields = template.content.cloneNode(true);

        newFields.querySelectorAll('[name*="NEW_RECORD"]').forEach(function(el) {
          el.name = el.name.replace(/NEW_RECORD/g, linkIndex);
        });

        container.appendChild(newFields);
        linkIndex++;
      });

      container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-link')) {
          e.preventDefault();
          const linkField = e.target.closest('.link-fields');
          const destroyInput = linkField.querySelector('input[name*="_destroy"]');

          if (destroyInput) {
            destroyInput.value = '1';
            linkField.style.display = 'none';
          } else {
            linkField.remove();
          }
        }
      });
    }
  })();
</script>
